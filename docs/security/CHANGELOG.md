# Changelog

## Unreleased

- **Refactored and improved CI workflow for better maintainability and reliability**: Enhanced `.github/workflows/ci.yml` with significant improvements: (1) **Workflow structure** - Renamed workflow from "CI/Security Scans" to "CI", simplified trigger syntax using array format, and added global permissions (`security-events: write`, `actions: read`) at workflow level, (2) **Job organization** - Added dedicated `install` job to separate dependency installation from testing, made `test` job depend on `install` for better job dependency management, (3) **CodeQL improvements** - Added explicit job name "CodeQL Analysis", added 10-minute timeout, removed redundant `category` parameter from analyze step, (4) **Dependency security scanning refactor** - Simplified installation process by removing complex `cyclonedx-bom` path detection logic and forced pip version pinning (`pip==24.2`), improved `pip-audit` vulnerability checking with robust JSON parsing that validates `.vulnerabilities` array structure and filters for HIGH/CRITICAL severity only, added Node.js setup and npm dependency installation with graceful fallback (`npm ci || npm install`), improved error handling with conditional checks for missing files and malformed JSON, added `if: always()` conditions to artifact uploads to ensure reports are saved even on failures, (5) **Trivy scan improvements** - Enhanced vulnerability checking logic with proper validation of SARIF structure (checks `.runs[0].results` array existence), improved error handling for missing files and edge cases, switched to `aquasecurity/trivy-action@master` for latest features, added `cache-dir` configuration for better performance, added `if: always()` conditions to ensure SARIF uploads and artifacts are saved regardless of scan outcome, (6) **Artifact management** - Added 30-day retention policy to all security report artifacts for better compliance and audit trail. All changes maintain backward compatibility while improving code maintainability, error handling, and CI reliability. Implemented on 2025-01-XX.
- **Implemented comprehensive security scanning in CI workflow**: Added automated security checks to `.github/workflows/ci.yml` including: (1) **CodeQL Analysis** - Static code analysis for Python with results uploaded to GitHub Security tab, (2) **Dependency Security Scanning** - Uses `pip-audit` (v2.7.0) for Python dependencies and `npm audit` for Node.js dependencies, with fail-fast on High/Critical vulnerabilities, (3) **Trivy Security Scan** - Filesystem vulnerability scanning with SARIF output uploaded to GitHub Security tab, (4) **SBOM Generation** - Software Bill of Materials generation using `cyclonedx-bom` (v4.1.0). All security jobs include robust JSON parsing with validation to handle edge cases (empty vulnerability arrays, missing files, malformed JSON). Security reports are uploaded as artifacts with 30-day retention. Workflow permissions configured for `security-events: write` to enable GitHub Security integration. This addresses security best practices and provides continuous security monitoring. Implemented on 2025-11-17. See [SECURITY.md](./SECURITY.md) for details.
- **Fixed npm package-lock.json synchronization issues**: Regenerated `package-lock.json` to resolve CI failures where `npm ci` was failing due to lockfile being out of sync with `package.json`. Updated CI workflow to use `npm ci || npm install` fallback pattern for graceful handling of lockfile mismatches. This ensures CI jobs complete successfully even when lockfiles need regeneration. Implemented on 2025-11-17.
- **Fixed critical dependency vulnerabilities**: Updated Python and Go dependencies to address HIGH and CRITICAL vulnerabilities identified by Trivy scan. Python: `python-multipart` updated from `0.0.6` to `≥0.0.18` (fixes CVE-2024-24762, CVE-2024-53981). Go: `github.com/hashicorp/go-getter` updated from `v1.7.1` to `v1.7.9` (fixes CVE-2024-3817, CVE-2024-6257, CVE-2025-8959), `golang.org/x/crypto` updated from `v0.14.0` to `v0.35.0` (fixes CVE-2024-45337, CVE-2025-22869), `golang.org/x/oauth2` updated from `v0.1.0` to `v0.27.0` (fixes CVE-2025-22868), and `google.golang.org/grpc` updated from `v1.51.0` to `v1.58.3` (fixes GHSA-m425-mq94-257g). Updated in `requirements.txt` and `tests/terraform/go.mod`. All vulnerabilities resolved.
- **Migrated JWT secret management to AWS Secrets Manager with KMS encryption**: Replaced plain environment variable storage with secure Secrets Manager integration. JWT secret is now retrieved from AWS Secrets Manager (KMS-encrypted) via `src/utils/jwt_secret.py`. In production, the system fails fast if Secrets Manager is unavailable (no insecure fallbacks). In development, falls back to `JWT_SECRET` environment variable for local testing. Updated `src/middleware/jwt_auth.py`, `src/services/auth_service.py`, and `src/entrypoint.py` to use `get_jwt_secret()`. ECS task definitions updated to retrieve secret from Secrets Manager. IAM policies tightened to use least-privilege KMS key ARN instead of wildcard. Added diagnostic endpoint `/health/secret` for verification. This addresses security vulnerability V-012 and improves overall security posture. See [STRIDE_COVERAGE_ANALYSIS.md](./STRIDE_COVERAGE_ANALYSIS.md) for details.
- **Implemented API Gateway throttling**: Added API Gateway throttling configuration to protect against denial-of-service attacks. Configured via `aws_api_gateway_method_settings` resource in `infra/modules/api-gateway/main.tf` with rate limit (2000 requests/second) and burst limit (5000 concurrent requests). Throttling applies to all methods (`*/*`) in the production stage. Added `throttle_rate_limit` and `throttle_burst_limit` variables for configuration. This addresses DoS protection and improves system resilience. Implemented on 2025-11-17. See [STRIDE_COVERAGE_ANALYSIS.md](./STRIDE_COVERAGE_ANALYSIS.md) for details.
- **Implemented security headers middleware**: Added comprehensive security headers middleware (`SecurityHeadersMiddleware`) to protect against common web vulnerabilities. Implements OWASP-recommended headers: Strict-Transport-Security (HSTS), X-Content-Type-Options, X-Frame-Options, X-XSS-Protection, Content-Security-Policy, Referrer-Policy, and Permissions-Policy. Middleware is configurable via environment variables (`HSTS_MAX_AGE`, `HSTS_INCLUDE_SUBDOMAINS`, `HSTS_PRELOAD`, `CONTENT_SECURITY_POLICY`, `REFERRER_POLICY`, `PERMISSIONS_POLICY`) and can be disabled with `DISABLE_SECURITY_HEADERS=true`. Integrated into `src/entrypoint.py` with proper middleware ordering. Unit tests added in `tests/unit/test_security_headers.py`. This addresses information disclosure threats and improves overall security posture. Implemented on 2025-11-17. See [STRIDE_COVERAGE_ANALYSIS.md](./STRIDE_COVERAGE_ANALYSIS.md) for details.
- **Enabled S3 versioning**: Added S3 bucket versioning to protect against accidental overwrites and enable version recovery. Configured via `aws_s3_bucket_versioning` resource in `infra/modules/s3/main.tf`. This addresses tampering threats (V-012 / Risk R-008) and provides audit trail for package artifacts. Versioning works in conjunction with SSE-KMS encryption for comprehensive data protection. Implemented on 2025-11-17. See [STRIDE_COVERAGE_ANALYSIS.md](./STRIDE_COVERAGE_ANALYSIS.md) for details.
- **Fixed `/tracks` endpoint response format to match OpenAPI specification**: Updated the endpoint to return `{"plannedTracks": [...]}` instead of `{"tracks": [...]}` to match the OpenAPI spec requirement. Also updated track values to match spec enum values ("Performance track", "Access control track", "High assurance track", "Other Security track"). Updated `src/index.py` and `src/routes/system.py` for consistency. This completes full OpenAPI specification compliance (100% - 15/15 endpoints fully compliant). See [OPENAPI_COMPLIANCE_CHECK.md](../../OPENAPI_COMPLIANCE_CHECK.md) for details.
- **Fixed `/authenticate` endpoint response format to match OpenAPI specification**: Updated the endpoint to return just the token string (e.g., `"bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."`) instead of a JSON object, as required by the OpenAPI spec. This ensures autograder compatibility. Updated `src/services/auth_public.py` to return `JSONResponse(token_string)` and updated tests in `tests/unit/test_auth_public.py` and `tests/integration/terraform-script.py` to expect the new format. See [OPENAPI_COMPLIANCE_CHECK.md](../../OPENAPI_COMPLIANCE_CHECK.md) for details.
- **Added 501 "Not Implemented" response to `/authenticate` endpoint**: Implemented OpenAPI specification compliance by returning HTTP 501 when authentication is not available (JWT secret unavailable). The endpoint now checks `get_jwt_secret()` at the start of authentication and returns 501 with message "This system does not support authentication." if the secret is unavailable (None) or if Secrets Manager is inaccessible (RuntimeError in production). This ensures proper error handling per the OpenAPI spec requirement. Implemented in `src/services/auth_public.py`. See [OPENAPI_COMPLIANCE_CHECK.md](../../OPENAPI_COMPLIANCE_CHECK.md) for details.
- **Updated dependencies to fix security vulnerabilities**: Updated Python dependencies (`jinja2` 3.1.4 → 3.1.6, `requests` 2.32.3 → 2.32.4) and Go dependencies (`github.com/ulikunitz/xz` v0.5.10 → v0.5.15, `golang.org/x/net` v0.34.0 → v0.38.0) to address multiple CVEs including CVE-2024-56201, CVE-2024-56326, CVE-2025-27516, CVE-2024-47081, CVE-2025-58058, CVE-2025-22870, and CVE-2025-22872. Updated in `requirements.txt` and `tests/terraform/go.mod`.
- **Created OpenAPI compliance check document**: Added comprehensive compliance analysis document (`OPENAPI_COMPLIANCE_CHECK.md`) comparing the API implementation against the OpenAPI specification. The document provides endpoint-by-endpoint analysis, identifies compliance issues, and includes recommendations for full specification compliance. Current compliance rate: 100% (15/15 fully compliant).
- **Implemented SHA-256 hash verification** for package integrity: Hash computation during upload (both simple and multipart), storage in DynamoDB package metadata, and optional verification during download. Hash is included in API responses for client-side verification. Implemented in `src/services/s3_service.py` and `src/services/package_service.py`. See [SECURITY_IMPLEMENTATIONS.md](./SECURITY_IMPLEMENTATIONS.md) for details.
- **Migrated S3 encryption from AES256 to SSE-KMS**: Updated S3 bucket configuration to use customer-managed KMS key (`alias/acme-main-key`) for enhanced security, auditability, and compliance. IAM policies enforce KMS encryption for all S3 operations. Configuration updated in `infra/modules/s3/main.tf`. See [SECURITY_IMPLEMENTATIONS.md](./SECURITY_IMPLEMENTATIONS.md) for details.
- **Updated Terraform variables with defaults**: Added default values for `aws_region` (`us-east-1`) and `artifacts_bucket` (`pkg-artifacts`) to eliminate prompts during `terraform plan`. Variables can still be overridden via command line or `terraform.tfvars` files. Updated in `infra/envs/dev/variables.tf` and `infra/envs/dev/main.tf`.

## Previous Releases

- Improved`RateLimitMiddleware` cleanup to prevent unbounded memory growth by pruning stale client entries and purging empty per-client structures.
- Improved rate-limiter concurrency by introducing per-client `asyncio.Lock` instances while keeping a lightweight global gate for cleanup.
- Added production safeguards for admin-secret retrieval: admin/grader passwords are sourced from AWS Secrets Manager when `AUTH_ADMIN_SECRET_NAME` is set and the runtime IAM role has `secretsmanager:GetSecretValue`. All AWS Secrets Manager errors (including missing secret name, ClientError, parsing failures) now log at error level and fail fast in production (when `ENVIRONMENT=production`) instead of falling back to default passwords, preventing attackers from forcing use of well-known credentials. In non-production environments, failures log and fall back to built-in `DEFAULT_PASSWORDS` to keep local environments functional.
- Made `_load_expected_passwords` initialization thread-safe with a lock to prevent redundant Secrets Manager calls under concurrent load.
- Tightened password normalization by removing the legacy semicolon-stripping fallback, ensuring appended characters cannot match default credentials.
- Improved Secrets Manager parsing: validate password payload structure and enforce non-empty string entries before caching admin credentials. Acceptable secret payloads include lists (e.g., `["NewAdminPassword123!"]`) or objects with a `passwords` key (e.g., `{"passwords": ["NewAdminPassword123!"]}`).
- Centralized authorization header parsing in `src/utils/auth.py`, ensuring all components (middleware and legacy endpoints) interpret bearer tokens consistently and apply identical validation rules, removing duplicated logic between `src/index.py` and `src/middleware/jwt_auth.py`.
- Introduced a unit test (`tests/unit/test_auth_public.py::test_load_expected_passwords_raises_in_production`) that verifies production raises on secret load failures.
- Documented testing prerequisites in `docs/tests.md`, covering virtualenv setup and dependency installation to avoid `No module named pytest`.
- Validated rate-limit environment variables in `src/entrypoint.py` on startup: invalid or non-positive values trigger warnings and fall back to defaults (120 requests per 60 seconds per client IP), preventing crashes from misconfigured environment variables. Middleware registration is explicit.
- Reordered middleware in `src/entrypoint.py` so rate limiting executes before authentication (rate limiting added last, runs first in LIFO order), preventing brute-force attacks from bypassing rate limits. Added `DISABLE_RATE_LIMIT` environment variable support for trusted environments only.
- Updated `SECURITY.md` to reflect the strengthened secret-handling and rate-limit configuration safeguards.
- Standardized artifact error responses in `src/index.py` to use "There are missing fields..." phrasing for consistency and clearer messaging.
- Added `WWW-Authenticate: Bearer` header to all 401 Unauthorized responses across `src/utils/auth.py`, `src/index.py`, and `src/services/auth_service.py` to comply with RFC 7235 and help clients understand the required authentication scheme.
- Made CORS allowed origins configurable via `ALLOWED_ORIGINS` environment variable in `src/index.py`, defaulting to localhost for development. This enables deployment to production without code changes by setting production domains in the environment variable.
- Added `_format_error_detail` helper function in `src/index.py` to conditionally include exception details in error messages: includes `{str(e)}` in development for debugging, but excludes it in production to prevent information disclosure. Application logs (CloudWatch or local stdout) receive full stack traces via `logger.error(..., exc_info=True)`, but user-facing `HTTPException` payloads avoid embedding raw exception messages. Updated all artifact-related exception handlers to use this helper.
- Extracted admin authorization logic into `is_admin_user()` helper function in `src/index.py` to eliminate code duplication and ensure consistent admin checks across the codebase. The function checks roles, username, is_admin flag, and sub fields, and uses `DEFAULT_ADMIN_USERNAME` constant from `auth_service` instead of hardcoded values.
- Added upper bounds validation for rate limit configuration in `src/entrypoint.py`: `RATE_LIMIT_REQUESTS` is capped at 10000 and `RATE_LIMIT_WINDOW_SECONDS` is capped at 3600 seconds to prevent misconfiguration that could cause memory issues. Values exceeding these limits trigger warnings and fall back to defaults (120 requests per 60 seconds).
