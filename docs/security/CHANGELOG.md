# Changelog

## Unreleased

- **Implemented SHA-256 hash verification** for package integrity: Hash computation during upload (both simple and multipart), storage in DynamoDB package metadata, and optional verification during download. Hash is included in API responses for client-side verification. Implemented in `src/services/s3_service.py` and `src/services/package_service.py`. See [SECURITY_IMPLEMENTATIONS.md](./SECURITY_IMPLEMENTATIONS.md) for details.
- **Migrated S3 encryption from AES256 to SSE-KMS**: Updated S3 bucket configuration to use customer-managed KMS key (`alias/acme-main-key`) for enhanced security, auditability, and compliance. IAM policies enforce KMS encryption for all S3 operations. Configuration updated in `infra/modules/s3/main.tf`. See [SECURITY_IMPLEMENTATIONS.md](./SECURITY_IMPLEMENTATIONS.md) for details.
- **Updated Terraform variables with defaults**: Added default values for `aws_region` (`us-east-1`) and `artifacts_bucket` (`pkg-artifacts`) to eliminate prompts during `terraform plan`. Variables can still be overridden via command line or `terraform.tfvars` files. Updated in `infra/envs/dev/variables.tf` and `infra/envs/dev/main.tf`.

## Previous Releases

- Improved`RateLimitMiddleware` cleanup to prevent unbounded memory growth by pruning stale client entries and purging empty per-client structures.
- Improved rate-limiter concurrency by introducing per-client `asyncio.Lock` instances while keeping a lightweight global gate for cleanup.
- Added production safeguards for admin-secret retrieval: admin/grader passwords are sourced from AWS Secrets Manager when `AUTH_ADMIN_SECRET_NAME` is set and the runtime IAM role has `secretsmanager:GetSecretValue`. All AWS Secrets Manager errors (including missing secret name, ClientError, parsing failures) now log at error level and fail fast in production (when `ENVIRONMENT=production`) instead of falling back to default passwords, preventing attackers from forcing use of well-known credentials. In non-production environments, failures log and fall back to built-in `DEFAULT_PASSWORDS` to keep local environments functional.
- Made `_load_expected_passwords` initialization thread-safe with a lock to prevent redundant Secrets Manager calls under concurrent load.
- Tightened password normalization by removing the legacy semicolon-stripping fallback, ensuring appended characters cannot match default credentials.
- Improved Secrets Manager parsing: validate password payload structure and enforce non-empty string entries before caching admin credentials. Acceptable secret payloads include lists (e.g., `["NewAdminPassword123!"]`) or objects with a `passwords` key (e.g., `{"passwords": ["NewAdminPassword123!"]}`).
- Centralized authorization header parsing in `src/utils/auth.py`, ensuring all components (middleware and legacy endpoints) interpret bearer tokens consistently and apply identical validation rules, removing duplicated logic between `src/index.py` and `src/middleware/jwt_auth.py`.
- Introduced a unit test (`tests/unit/test_auth_public.py::test_load_expected_passwords_raises_in_production`) that verifies production raises on secret load failures.
- Documented testing prerequisites in `docs/tests.md`, covering virtualenv setup and dependency installation to avoid `No module named pytest`.
- Validated rate-limit environment variables in `src/entrypoint.py` on startup: invalid or non-positive values trigger warnings and fall back to defaults (120 requests per 60 seconds per client IP), preventing crashes from misconfigured environment variables. Middleware registration is explicit.
- Reordered middleware in `src/entrypoint.py` so rate limiting executes before authentication (rate limiting added last, runs first in LIFO order), preventing brute-force attacks from bypassing rate limits. Added `DISABLE_RATE_LIMIT` environment variable support for trusted environments only.
- Updated `SECURITY.md` to reflect the strengthened secret-handling and rate-limit configuration safeguards.
- Standardized artifact error responses in `src/index.py` to use "There are missing fields..." phrasing for consistency and clearer messaging.
- Added `WWW-Authenticate: Bearer` header to all 401 Unauthorized responses across `src/utils/auth.py`, `src/index.py`, and `src/services/auth_service.py` to comply with RFC 7235 and help clients understand the required authentication scheme.
- Made CORS allowed origins configurable via `ALLOWED_ORIGINS` environment variable in `src/index.py`, defaulting to localhost for development. This enables deployment to production without code changes by setting production domains in the environment variable.
- Added `_format_error_detail` helper function in `src/index.py` to conditionally include exception details in error messages: includes `{str(e)}` in development for debugging, but excludes it in production to prevent information disclosure. Application logs (CloudWatch or local stdout) receive full stack traces via `logger.error(..., exc_info=True)`, but user-facing `HTTPException` payloads avoid embedding raw exception messages. Updated all artifact-related exception handlers to use this helper.
- Extracted admin authorization logic into `is_admin_user()` helper function in `src/index.py` to eliminate code duplication and ensure consistent admin checks across the codebase. The function checks roles, username, is_admin flag, and sub fields, and uses `DEFAULT_ADMIN_USERNAME` constant from `auth_service` instead of hardcoded values.
- Added upper bounds validation for rate limit configuration in `src/entrypoint.py`: `RATE_LIMIT_REQUESTS` is capped at 10000 and `RATE_LIMIT_WINDOW_SECONDS` is capped at 3600 seconds to prevent misconfiguration that could cause memory issues. Values exceeding these limits trigger warnings and fall back to defaults (120 requests per 60 seconds).
